<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>こども とけい + タイマー（拡張版）</title>
<style>
  :root{
    --bg:#fffaf2; --ink:#202124; --muted:#5f6368; --accent:#3a86ff;
    --good:#1e9e77; --bad:#e85b4f; --panel:#ffffff; --ring:#e8eaed; --chip:#f1f3f4;
  }
  /* themes */
  [data-theme="simple"]{ --bg:#fffaf2; --accent:#3a86ff; --panel:#ffffff; }
  [data-theme="cute"]  { --bg:#fff7fb; --accent:#ff6fb5; --panel:#fff; }
  [data-theme="school"]{ --bg:#f7fbff; --accent:#2a9d8f; --panel:#ffffff; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    background: radial-gradient(1200px 800px at 70% -10%, #eef6ff 0%, var(--bg) 40%) no-repeat;
    color:var(--ink);
    display:flex; justify-content:center; align-items:center; padding:16px;
  }
  .app{ width:min(1200px,100%); display:grid; grid-template-columns: 1fr 420px; gap:16px; }
  @media (max-width: 980px){ .app{grid-template-columns:1fr} }
  .card{ background:var(--panel); border:1px solid var(--ring); border-radius:16px; box-shadow: 0 10px 24px rgba(0,0,0,.05); padding:16px; }
  .clock-wrap{ display:grid; grid-template-rows:auto 1fr auto; gap:12px; height:100% }
  .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between }
  .mode{ display:flex; gap:6px; background:#f7f7fb; border-radius:999px; padding:6px; border:1px solid var(--ring) }
  .mode button{ border:0; background:transparent; padding:8px 14px; border-radius:999px; cursor:pointer; font-weight:700; color:var(--muted) }
  .mode button.active{ background:var(--accent); color:white }
  .right.row, .left.row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  button{ border:1px solid var(--ring); background:white; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700 }
  button.primary{ background:var(--accent); color:white; border-color:transparent }
  button.ghost{ background:transparent }
  select,input[type="number"],input[type="text"]{ border:1px solid var(--ring); background:white; padding:10px 12px; border-radius:12px; font-weight:700 }
  .digital{ font-feature-settings:"tnum"; font-variant-numeric:tabular-nums; font-size:1.6rem; font-weight:800 }
  .muted{ color:var(--muted) }
  .legend{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-size:.95rem }
  .dot{ width:12px; height:12px; border-radius:50% }
  .dot.hour{ background:#111 } .dot.min{ background:#777 } .dot.sec{ background:#d00 }
  .status{ display:flex; gap:8px; align-items:center; justify-content:space-between; font-weight:700 }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px } @media (max-width:520px){ .grid2{grid-template-columns:1fr} }
  .chip{ background:var(--chip); border:1px solid var(--ring); padding:8px 12px; border-radius:999px; font-weight:700 }
  .clock{ display:flex; align-items:center; justify-content:center; width:100%; height:min(70vh, 660px) }
  .section-title{ font-size:1.1rem; font-weight:800 }
  .activity{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
</style>
</head>
<body data-theme="simple">
  <div class="app">
    <div class="card clock-wrap">
      <div class="toolbar">
        <div class="left row">
          <div class="mode" role="tablist" aria-label="モード">
            <button class="active" data-mode="learn">れんしゅう</button>
            <button data-mode="realtime">いまのじかん</button>
          </div>
          <div class="chip">テーマ:
            <select id="themeSel">
              <option value="simple">シンプル</option>
              <option value="cute">かわいい</option>
              <option value="school">スクール</option>
            </select>
          </div>
          <div class="digital" id="digital">--:--</div>
        </div>
        <div class="right row">
          <button id="randomBtn" class="primary">ランダム</button>
          <button id="resetBtn" class="ghost">リセット</button>
        </div>
      </div>

      <div class="activity">
        <span class="muted">いま：</span>
        <span id="nowDoing" class="section-title">未設定</span>
      </div>

      <div class="clock">
        <svg id="clock" viewBox="-160 -160 320 320" aria-label="アナログ時計" role="img">
          <defs>
            <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
              <feDropShadow dx="0" dy="3" stdDeviation="3" flood-color="#000" flood-opacity="0.15"/>
            </filter>
          </defs>
          <circle r="145" fill="#fff" stroke="#dfe3e8" stroke-width="2" filter="url(#shadow)"></circle>
          <g id="hours"></g>
          <g id="minTicks"></g>
          <g id="hands">
            <line id="hourHand" x1="0" y1="12" x2="0" y2="-75" stroke="#111" stroke-width="6" stroke-linecap="round"></line>
            <line id="minHand"  x1="0" y1="16" x2="0" y2="-118" stroke="#555" stroke-width="4" stroke-linecap="round"></line>
            <line id="secHand"  x1="0" y1="20" x2="0" y2="-125" stroke="#d00" stroke-width="2" stroke-linecap="round"></line>
            <circle r="5" fill="#111"></circle>
          </g>
        </svg>
      </div>

      <div class="status">
        <div class="legend muted">
          <span class="dot hour"></span><span>時針</span>
          <span class="dot min"></span><span>分針</span>
          <span class="dot sec"></span><span>秒針</span>
        </div>
        <div id="msg" class="muted">モード：れんしゅう（ドラッグで動くよ）</div>
      </div>
    </div>

    <div class="card">
      <div class="row"><span class="section-title">タイマー ⏱️</span>
        <button id="startTimer" class="primary">スタート</button>
        <button id="pauseTimer">一時停止</button>
        <button id="resetTimer" class="ghost">リセット</button>
      </div>
      <div class="row">
        <label>分 <input id="tMin" type="number" min="0" max="180" value="5" style="width:90px"></label>
        <label>秒 <input id="tSec" type="number" min="0" max="59" value="0" style="width:90px"></label>
        <span class="digital" id="remain">05:00</span>
      </div>
      <hr>

      <div class="row"><span class="section-title">音声とアラート</span>
        <label><input type="checkbox" id="voiceOn" checked> しゃべる</label>
        <label>毎分アナウンス
          <select id="minEvery">
            <option value="0">しない</option>
            <option value="1" selected>毎分</option>
            <option value="2">2分ごと</option>
            <option value="3">3分ごと</option>
            <option value="5">5分ごと</option>
          </select>
        </label>
        <label><input type="checkbox" id="last10" checked> 最後10秒カウント</label>
      </div>
      <div class="row">
        <label>事前アラート（例：5m,3m,1m,30s）
          <input id="preAlerts" type="text" value="5m,1m,30s" style="width:260px">
        </label>
        <label>終了メッセージ
          <input id="endPhrase" type="text" value="おわり" style="width:180px">
        </label>
      </div>
      <div class="row">
        <label>声の速さ <input type="range" id="rate" min="0.6" max="1.4" step="0.05" value="1"></label>
        <label>声の高さ <input type="range" id="pitch" min="0.8" max="1.2" step="0.05" value="1"></label>
        <button id="sayBtn">▶︎ よむ</button>
        <button id="beepBtn">♪ ビープ</button>
      </div>
      <hr>

      <div class="row"><span class="section-title">なにをしてる？</span></div>
      <div class="row" id="activityChips"></div>
      <div class="row">
        <input type="text" id="customAct" placeholder="カスタム（例：おかたづけ）" style="flex:1">
        <button id="addAct">追加</button>
      </div>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const two = n => String(Math.floor(n)).padStart(2,'0');
const save = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
const load = (k,def)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } };

// Dial
const hoursG = document.getElementById('hours');
const minsG = document.getElementById('minTicks');
for(let i=1;i<=12;i++){
  const a=(i/12)*2*Math.PI, x=Math.sin(a)*100, y=-Math.cos(a)*100;
  const t=document.createElementNS('http://www.w3.org/2000/svg','text');
  t.setAttribute('x',x); t.setAttribute('y',y+6); t.setAttribute('text-anchor','middle');
  t.setAttribute('font-size','18'); t.setAttribute('font-weight','700'); t.textContent=i; hoursG.appendChild(t);
}
for(let i=0;i<60;i++){
  const a=(i/60)*2*Math.PI;
  const x1=Math.sin(a)*126, y1=-Math.cos(a)*126;
  const x2=Math.sin(a)*(i%5===0?135:140), y2=-Math.cos(a)*(i%5===0?135:140);
  const l=document.createElementNS('http://www.w3.org/2000/svg','line');
  l.setAttribute('x1',x1); l.setAttribute('y1',y1); l.setAttribute('x2',x2); l.setAttribute('y2',y2);
  l.setAttribute('stroke', i%5===0 ? '#222' : '#bbb'); l.setAttribute('stroke-width', i%5===0?'2.5':'1'); minsG.appendChild(l);
  if(i%5===0){ const lab=document.createElementNS('http://www.w3.org/2000/svg','text');
    lab.setAttribute('x',Math.sin(a)*90); lab.setAttribute('y',-Math.cos(a)*90+5);
    lab.setAttribute('text-anchor','middle'); lab.setAttribute('font-size','10'); lab.setAttribute('fill','#666'); lab.textContent=i; minsG.appendChild(lab);
  }
}

// Clock state
let mode='learn', hour=3, minute=0, second=0, rtId=null, drag=null;
const hourHand=$('#hourHand'), minHand=$('#minHand'), secHand=$('#secHand'), digital=$('#digital'), msg=$('#msg');

function updateHands(){
  const hAng=((hour%12)+minute/60+second/3600)*30;
  const mAng=(minute+second/60)*6;
  const sAng=second*6;
  hourHand.setAttribute('transform',`rotate(${hAng})`);
  minHand.setAttribute('transform',`rotate(${mAng})`);
  secHand.setAttribute('transform',`rotate(${sAng})`);
  digital.textContent=`${two(hour)}:${two(minute)}`;
}

function setMode(m){
  mode=m;
  document.querySelectorAll('.mode button').forEach(b=>b.classList.toggle('active', b.dataset.mode===m));
  if(rtId){ cancelAnimationFrame(rtId); rtId=null; }
  if(m==='realtime'){
    msg.textContent='モード：いまのじかん（秒針あり）';
    const tick=()=>{ const d=new Date(); hour=d.getHours(); minute=d.getMinutes(); second=d.getSeconds(); updateHands(); rtId=requestAnimationFrame(tick); };
    tick();
  }else{
    msg.textContent='モード：れんしゅう（ドラッグで動くよ）'; second=0; updateHands();
  }
}
document.querySelectorAll('.mode button').forEach(btn=>btn.addEventListener('click',()=>setMode(btn.dataset.mode)));

// Drag
const svg=document.getElementById('clock');
function ang(evt){
  const r=svg.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
  const x=(evt.touches?evt.touches[0].clientX:evt.clientX)-cx;
  const y=(evt.touches?evt.touches[0].clientY:evt.clientY)-cy;
  return (Math.atan2(y,x)*180/Math.PI+90+360)%360;
}
function onDown(e){
  if(mode!=='learn') return;
  const a=ang(e), mAng=minute*6, hAng=((hour%12)+minute/60)*30;
  const dM=Math.min(Math.abs((a-mAng+360)%360),Math.abs((mAng-a+360)%360));
  const dH=Math.min(Math.abs((a-hAng+360)%360),Math.abs((hAng-a+360)%360));
  drag=dM<dH?'min':'hour'; document.body.style.userSelect='none';
}
function onMove(e){
  if(!drag || mode!=='learn') return;
  const a=ang(e);
  if(drag==='min'){ minute=Math.round(a/6)%60; }
  else{ const h=(a/30)%12; const base=Math.floor(hour/12)*12; hour=base+Math.round(h)%12; }
  updateHands();
}
function onUp(){ drag=null; document.body.style.userSelect=''; }
svg.addEventListener('mousedown',onDown); svg.addEventListener('mousemove',onMove); window.addEventListener('mouseup',onUp);
svg.addEventListener('touchstart',onDown,{passive:true}); svg.addEventListener('touchmove',onMove,{passive:true}); window.addEventListener('touchend',onUp);

// Buttons
$('#randomBtn').addEventListener('click',()=>{ hour=Math.floor(Math.random()*24); minute=Math.floor(Math.random()*60); second=0; updateHands(); });
$('#resetBtn').addEventListener('click',()=>{ hour=3; minute=0; second=0; updateHands(); });

// Theme
const themeSel=$('#themeSel');
themeSel.value = load('theme','simple'); document.body.setAttribute('data-theme', themeSel.value);
themeSel.addEventListener('change',()=>{ document.body.setAttribute('data-theme', themeSel.value); save('theme', themeSel.value); });

// Timer & Voice
let timerId=null, endAt=null, pausedRemain=0;
const tMin=$('#tMin'), tSec=$('#tSec'), remain=$('#remain');
const minEvery=$('#minEvery'), last10=$('#last10'), preAlerts=$('#preAlerts'), endPhrase=$('#endPhrase');

[minEvery,last10,preAlerts,endPhrase,tMin,tSec].forEach(el=>{
  const k='kv_'+el.id; const v=load(k,null); if(v!==null){ if(el.type==='checkbox') el.checked=v; else el.value=v; }
  el.addEventListener('change',()=>save(k, el.type==='checkbox'?el.checked:el.value));
});

function speak(text){
  if(!$('#voiceOn').checked) return;
  const u=new SpeechSynthesisUtterance(text);
  const vs=speechSynthesis.getVoices(); const ja=vs.find(v=>v.lang && v.lang.toLowerCase().startsWith('ja')); if(ja) u.voice=ja;
  u.rate=Number($('#rate').value); u.pitch=Number($('#pitch').value);
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}
function beep(ms=350, freq=880){
  const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return;
  if(!beep.ctx) beep.ctx=new AC();
  const ctx=beep.ctx, o=ctx.createOscillator(), g=ctx.createGain();
  o.frequency.value=freq; o.type='sine'; g.gain.setValueAtTime(0.001, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.02);
  g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+ms/1000);
  o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+ms/1000);
}

function parseAlerts(text){
  return text.split(',').map(s=>s.trim()).filter(Boolean).map(tok=>{
    const m = tok.match(/^(\d+)\s*([ms]?)$/i); if(!m) return null;
    const n=Number(m[1]); const unit=(m[2]||'s').toLowerCase();
    return unit==='m' ? n*60 : n;
  }).filter(x=>x!==null).sort((a,b)=>b-a);
}

function fmtRemain(ms){
  const s=Math.max(0, Math.round(ms/1000));
  return `${two(Math.floor(s/60))}:${two(s%60)}`;
}
function updateRemain(){ remain.textContent = fmtRemain( (endAt? endAt-Date.now() : (Number(tMin.value)*60+Number(tSec.value))*1000) ); }

function currentActivity(){
  return acts[actIdx]?.label ? `${acts[actIdx].emoji||''} ${acts[actIdx].label}` : '';
}

function startTimer(){
  beep(120,660);
  const total=(Number(tMin.value)*60 + Number(tSec.value))*1000;
  if(total<=0){ speak('タイマー時間を設定してね'); return; }
  const act=currentActivity();
  const alertSecs=parseAlerts(preAlerts.value);
  const minInt=Number(minEvery.value);
  let fired = new Set();
  endAt=Date.now() + (pausedRemain || total);
  if(timerId) clearInterval(timerId);
  const tick=()=>{
    const left=endAt - Date.now();
    const s=Math.ceil(left/1000);
    alertSecs.forEach(sec=>{ if(s===sec && !fired.has(sec)){ fired.add(sec); const unit = sec>=60 ? `${Math.floor(sec/60)}分前` : `${sec}秒前`; speak(`${unit}`); beep(160,880);} });
    if(minInt>0 && s>0 && s%(minInt*60)===0){ const m=Math.floor(s/60); speak(`${m}分 のこり`); }
    if(last10.checked && s<=10 && s>0){ speak(String(s)); }
    if(left<=0){
      clearInterval(timerId); timerId=null; pausedRemain=0; endAt=null;
      const label = act ? `「${act}」` : '';
      beep(220,660); setTimeout(()=>beep(220,880),230);
      speak(`タイマー終了。${label}${endPhrase.value}`);
      updateRemain(); return;
    }
    updateRemain();
  };
  tick(); timerId=setInterval(tick, 250);
  speak(`タイマーを開始。${Math.floor(total/60000)}分${(total/1000)%60? ( (total/1000)%60 + '秒') : ''}` + (act? `、いまは ${act}`:''));
}
function pauseTimer(){ if(!endAt) return; pausedRemain=Math.max(0, endAt-Date.now()); endAt=null; if(timerId) clearInterval(timerId); timerId=null; speak('いったん きゅうけい'); }
function resetTimer(){ endAt=null; pausedRemain=0; if(timerId) clearInterval(timerId); timerId=null; updateRemain(); }

$('#startTimer').addEventListener('click', startTimer);
$('#pauseTimer').addEventListener('click', pauseTimer);
$('#resetTimer').addEventListener('click', resetTimer);
$('#sayBtn').addEventListener('click',()=>speak('テストです。こんにちは。'));
$('#beepBtn').addEventListener('click',()=>beep());

tMin.addEventListener('change',updateRemain); tSec.addEventListener('change',updateRemain);

// Activities
const defaultActs=[ {label:'ご飯',emoji:'🍚'}, {label:'勉強',emoji:'✏️'}, {label:'遊び',emoji:'🎲'}, {label:'動画',emoji:'📺'} ];
function loadActs(){ const x=load('acts',null); return x && x.length ? x : defaultActs; }
function saveActs(list){ save('acts',list); }
function renderActs(){ const box=$('#activityChips'); box.innerHTML=''; acts.forEach((a,i)=>{ const b=document.createElement('button'); b.className='chip'+(i===actIdx?' active':''); b.textContent=`${a.emoji||''} ${a.label}`; b.addEventListener('click',()=>{actIdx=i; renderActs(); updateNowDoing();}); box.appendChild(b); }); }
function updateNowDoing(){ $('#nowDoing').textContent = currentActivity() || '未設定'; }
let acts=loadActs(); let actIdx=0; renderActs(); updateNowDoing();
$('#addAct').addEventListener('click',()=>{ const t=$('#customAct').value.trim(); if(!t) return; acts.push({label:t,emoji:'⭐'}); saveActs(acts); actIdx=acts.length-1; $('#customAct').value=''; renderActs(); updateNowDoing(); });

// Voices & init
function initVoices(){ speechSynthesis.getVoices(); }
if(typeof speechSynthesis!=='undefined'){ speechSynthesis.onvoiceschanged=initVoices; initVoices(); }
hour=3; minute=0; second=0; updateHands(); setMode('learn'); updateRemain();
</script>
</body>
</html>
